<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!-->
<html class="no-js" lang="en">
 <!--<![endif]-->
 <head>
  <meta charset="utf-8"/>
  <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
  <title>
   FullyShardedDataParallel — PyTorch 1.12 documentation
  </title>
  <!-- <link rel="stylesheet" href="_static/pygments.css" type="text/css" /> -->
  <!-- Google Analytics -->
  <!-- End Google Analytics -->
  <!-- Preload the theme fonts -->
  <!-- Preload the katex fonts -->
 </head>
 <body class="pytorch-body">
  <div class="pytorch-container">
   <section class="pytorch-content-wrap" data-toggle="wy-nav-shift" id="pytorch-content-wrap">
    <div class="pytorch-content-left">
     <div class="rst-content">
      <div class="main-content" itemscope="itemscope" itemtype="http://schema.org/Article" role="main">
       <article class="pytorch-article" id="pytorch-article" itemprop="articleBody">
        <div class="section" id="module-torch.distributed.fsdp">
         <span id="fullyshardeddataparallel">
         </span>
         <h1>
          FullyShardedDataParallel
          <a class="headerlink" href="#module-torch.distributed.fsdp" title="Permalink to this headline">
           ¶
          </a>
         </h1>
         <dl class="py class">
          <dt id="torch.distributed.fsdp.FullyShardedDataParallel">
           <em class="property">
            <span class="pre">
             class
            </span>
           </em>
           <code class="sig-prename descclassname">
            <span class="pre">
             torch.distributed.fsdp.
            </span>
           </code>
           <code class="sig-name descname">
            <span class="pre">
             FullyShardedDataParallel
            </span>
           </code>
           <span class="sig-paren">
            (
           </span>
           <em class="sig-param">
            <span class="n">
             <span class="pre">
              module
             </span>
            </span>
           </em>
           ,
           <em class="sig-param">
            <span class="n">
             <span class="pre">
              process_group
             </span>
            </span>
            <span class="o">
             <span class="pre">
              =
             </span>
            </span>
            <span class="default_value">
             <span class="pre">
              None
             </span>
            </span>
           </em>
           ,
           <em class="sig-param">
            <span class="n">
             <span class="pre">
              sharding_strategy
             </span>
            </span>
            <span class="o">
             <span class="pre">
              =
             </span>
            </span>
            <span class="default_value">
             <span class="pre">
              None
             </span>
            </span>
           </em>
           ,
           <em class="sig-param">
            <span class="n">
             <span class="pre">
              cpu_offload
             </span>
            </span>
            <span class="o">
             <span class="pre">
              =
             </span>
            </span>
            <span class="default_value">
             <span class="pre">
              None
             </span>
            </span>
           </em>
           ,
           <em class="sig-param">
            <span class="n">
             <span class="pre">
              auto_wrap_policy
             </span>
            </span>
            <span class="o">
             <span class="pre">
              =
             </span>
            </span>
            <span class="default_value">
             <span class="pre">
              None
             </span>
            </span>
           </em>
           ,
           <em class="sig-param">
            <span class="n">
             <span class="pre">
              backward_prefetch
             </span>
            </span>
            <span class="o">
             <span class="pre">
              =
             </span>
            </span>
            <span class="default_value">
             <span class="pre">
              None
             </span>
            </span>
           </em>
           ,
           <em class="sig-param">
            <span class="n">
             <span class="pre">
              mixed_precision
             </span>
            </span>
            <span class="o">
             <span class="pre">
              =
             </span>
            </span>
            <span class="default_value">
             <span class="pre">
              None
             </span>
            </span>
           </em>
           ,
           <em class="sig-param">
            <span class="n">
             <span class="pre">
              ignored_modules
             </span>
            </span>
            <span class="o">
             <span class="pre">
              =
             </span>
            </span>
            <span class="default_value">
             <span class="pre">
              None
             </span>
            </span>
           </em>
           ,
           <em class="sig-param">
            <span class="n">
             <span class="pre">
              param_init_fn
             </span>
            </span>
            <span class="o">
             <span class="pre">
              =
             </span>
            </span>
            <span class="default_value">
             <span class="pre">
              None
             </span>
            </span>
           </em>
           ,
           <em class="sig-param">
            <span class="n">
             <span class="pre">
              device_id
             </span>
            </span>
            <span class="o">
             <span class="pre">
              =
             </span>
            </span>
            <span class="default_value">
             <span class="pre">
              None
             </span>
            </span>
           </em>
           ,
           <em class="sig-param">
            <span class="n">
             <span class="pre">
              sync_module_states
             </span>
            </span>
            <span class="o">
             <span class="pre">
              =
             </span>
            </span>
            <span class="default_value">
             <span class="pre">
              False
             </span>
            </span>
           </em>
           <span class="sig-paren">
            )
           </span>
           <a class="reference internal" href="_modules/torch/distributed/fsdp/fully_sharded_data_parallel.html#FullyShardedDataParallel">
            <span class="viewcode-link">
             <span class="pre">
              [source]
             </span>
            </span>
           </a>
           <a class="headerlink" href="#torch.distributed.fsdp.FullyShardedDataParallel" title="Permalink to this definition">
            ¶
           </a>
          </dt>
          <dd>
           <p>
            A wrapper for sharding Module parameters across data parallel workers. This
is inspired by
            <a class="reference external" href="https://arxiv.org/abs/2004.13336">
             Xu et al.
            </a>
            as well as the ZeRO Stage 3 from
            <a class="reference external" href="https://www.deepspeed.ai/">
             DeepSpeed
            </a>
            .
FullyShardedDataParallel is commonly shortened to FSDP.
           </p>
           <p>
            Example:
           </p>
           <div class="highlight-default notranslate">
            <div class="highlight">
             <pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">torch</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">torch.distributed.fsdp</span> <span class="kn">import</span> <span class="n">FullyShardedDataParallel</span> <span class="k">as</span> <span class="n">FSDP</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">set_device</span><span class="p">(</span><span class="n">device_id</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">sharded_module</span> <span class="o">=</span> <span class="n">FSDP</span><span class="p">(</span><span class="n">my_module</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">optim</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">sharded_module</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="mf">0.0001</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">x</span> <span class="o">=</span> <span class="n">sharded_module</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">z</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">([</span><span class="mi">1</span><span class="p">]))</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">loss</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">optim</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
</pre>
            </div>
           </div>
           <div class="admonition warning">
            <p class="admonition-title">
             Warning
            </p>
            <p>
             The optimizer must be initialized
             <em>
              after
             </em>
             the module has been wrapped,
since FSDP will shard parameters in-place and this will break any
previously initialized optimizers.
            </p>
           </div>
           <div class="admonition warning">
            <p class="admonition-title">
             Warning
            </p>
            <p>
             If the destination CUDA device has ID
             <code class="docutils literal notranslate">
              <span class="pre">
               dev_id
              </span>
             </code>
             , either (1)
             <code class="docutils literal notranslate">
              <span class="pre">
               module
              </span>
             </code>
             should already be placed on that device, (2) the device
should be set using
             <code class="docutils literal notranslate">
              <span class="pre">
               torch.cuda.set_device(dev_id)
              </span>
             </code>
             , or (3)
             <code class="docutils literal notranslate">
              <span class="pre">
               dev_id
              </span>
             </code>
             should be passed into the
             <code class="docutils literal notranslate">
              <span class="pre">
               device_id
              </span>
             </code>
             constructor
argument. This FSDP instance’s compute device will be that destination
device. For (1) and (3), the FSDP initialization always occurs on GPU.
For (2), the FSDP initialization happens on
             <code class="docutils literal notranslate">
              <span class="pre">
               module
              </span>
             </code>
             ‘s current
device, which may be CPU.
            </p>
           </div>
           <div class="admonition warning">
            <p class="admonition-title">
             Warning
            </p>
            <p>
             FSDP currently does not support gradient accumulation outside
             <code class="docutils literal notranslate">
              <span class="pre">
               no_sync()
              </span>
             </code>
             when using CPU offloading. Trying to do so yields
incorrect results since FSDP will use the newly-reduced gradient
instead of accumulating with any existing gradient.
            </p>
           </div>
           <div class="admonition warning">
            <p class="admonition-title">
             Warning
            </p>
            <p>
             Changing the original parameter variable names after construction will
lead to undefined behavior.
            </p>
           </div>
           <div class="admonition warning">
            <p class="admonition-title">
             Warning
            </p>
            <p>
             Passing in
             <cite>
              sync_module_states=True
             </cite>
             flag requires module to be put
on GPU, or to use
             <code class="docutils literal notranslate">
              <span class="pre">
               device_id
              </span>
             </code>
             argument to specify a CUDA device that
FSDP will move module to. This is because
             <code class="docutils literal notranslate">
              <span class="pre">
               sync_module_states=True
              </span>
             </code>
             requires GPU communication.
            </p>
           </div>
           <div class="admonition warning">
            <p class="admonition-title">
             Warning
            </p>
            <p>
             As of PyTorch 1.12, FSDP only offers limited support for shared parameters
(for example, setting one
             <code class="docutils literal notranslate">
              <span class="pre">
               Linear
              </span>
             </code>
             layer’s weight to another’s). In
particular, modules that share parameters must be wrapped as part of the
same FSDP unit. If enhanced shared parameter support is needed for your
use case, please ping
             <a class="reference external" href="https://github.com/pytorch/pytorch/issues/77724">
              https://github.com/pytorch/pytorch/issues/77724
             </a>
            </p>
           </div>
           <div class="admonition note">
            <p class="admonition-title">
             Note
            </p>
            <p>
             Inputs into FSDP
             <code class="docutils literal notranslate">
              <span class="pre">
               forward
              </span>
             </code>
             function will be moved to compute device
(same device FSDP module is on) before running
             <code class="docutils literal notranslate">
              <span class="pre">
               forward
              </span>
             </code>
             , so user does
not have to manually move inputs from CPU -&gt; GPU.
            </p>
           </div>
           <dl class="field-list simple">
            <dt class="field-odd">
             Parameters
            </dt>
            <dd class="field-odd">
             <ul class="simple">
              <li>
               <p>
                <strong>
                 module
                </strong>
                (
                <a class="reference internal" href="generated/torch.nn.Module.html#torch.nn.Module" title="torch.nn.Module">
                 <em>
                  nn.Module
                 </em>
                </a>
                ) – module to be wrapped with FSDP.
               </p>
              </li>
              <li>
               <p>
                <strong>
                 process_group
                </strong>
                (
                <em>
                 Optional
                </em>
                <em>
                 [
                </em>
                <em>
                 ProcessGroup
                </em>
                <em>
                 ]
                </em>
                ) – process group for sharding
               </p>
              </li>
              <li>
               <p>
                <strong>
                 sharding_strategy
                </strong>
                (
                <em>
                 Optional
                </em>
                <em>
                 [
                </em>
                <em>
                 ShardingStrategy
                </em>
                <em>
                 ]
                </em>
                ) – Config sharding algorithm, different sharding algorithm has trade
off between memory saving and communication overhead.
                <code class="docutils literal notranslate">
                 <span class="pre">
                  FULL_SHARD
                 </span>
                </code>
                will be chosen if sharding_strategy is not specified.
               </p>
              </li>
              <li>
               <p>
                <strong>
                 cpu_offload
                </strong>
                (
                <em>
                 Optional
                </em>
                <em>
                 [
                </em>
                <em>
                 CPUOffload
                </em>
                <em>
                 ]
                </em>
                ) – CPU offloading config. Currently, only parameter and gradient CPU
offload is supported. It can be enabled via passing in
                <code class="docutils literal notranslate">
                 <span class="pre">
                  cpu_offload=CPUOffload(offload_params=True)
                 </span>
                </code>
                . Note that this
currently implicitly enables gradient offloading to CPU in order for
params and grads to be on same device to work with optimizer. This
API is subject to change. Default is
                <code class="docutils literal notranslate">
                 <span class="pre">
                  None
                 </span>
                </code>
                in which case there
will be no offloading.
               </p>
              </li>
              <li>
               <p>
                <strong>
                 auto_wrap_policy
                </strong>
                (
                <em>
                 Optional
                </em>
                <em>
                 [
                </em>
                <em>
                 Callable
                </em>
                <em>
                 ]
                </em>
                ) –
                <p>
                 A callable specifying a policy to recursively wrap layers with FSDP.
Note that this policy currently will only apply to child modules of
the passed in module. The remainder modules are always wrapped in
the returned FSDP root instance.
                 <code class="docutils literal notranslate">
                  <span class="pre">
                   size_based_auto_wrap_policy
                  </span>
                 </code>
                 written in
                 <code class="docutils literal notranslate">
                  <span class="pre">
                   torch.distributed.fsdp.wrap
                  </span>
                 </code>
                 is
an example of
                 <code class="docutils literal notranslate">
                  <span class="pre">
                   auto_wrap_policy
                  </span>
                 </code>
                 callable, this policy wraps layers
with the number of parameters larger than 100M.
                 <code class="docutils literal notranslate">
                  <span class="pre">
                   transformer_auto_wrap_policy
                  </span>
                 </code>
                 written in
                 <code class="docutils literal notranslate">
                  <span class="pre">
                   torch.distributed.fsdp.wrap
                  </span>
                 </code>
                 is an example of
                 <code class="docutils literal notranslate">
                  <span class="pre">
                   auto_wrap_policy
                  </span>
                 </code>
                 callable for tranformer-like model architectures. Users can supply the customized
                 <code class="docutils literal notranslate">
                  <span class="pre">
                   auto_wrap_policy
                  </span>
                 </code>
                 callable that should accept following arguments:
                 <code class="docutils literal notranslate">
                  <span class="pre">
                   module:
                  </span>
                  <span class="pre">
                   nn.Module
                  </span>
                 </code>
                 ,
                 <code class="docutils literal notranslate">
                  <span class="pre">
                   recurse:
                  </span>
                  <span class="pre">
                   bool
                  </span>
                 </code>
                 ,
                 <code class="docutils literal notranslate">
                  <span class="pre">
                   unwrapped_params:
                  </span>
                  <span class="pre">
                   int
                  </span>
                 </code>
                 ,
extra customized arguments could be added to the customized
                 <code class="docutils literal notranslate">
                  <span class="pre">
                   auto_wrap_policy
                  </span>
                 </code>
                 callable as well. It is a good practice to print out
the sharded model and check whether the sharded model is what
the application wants and then adjust accordingly.
                </p>
                <p>
                 Example:
                </p>
                <div class="highlight-default notranslate">
                 <div class="highlight">
                  <pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="k">def</span> <span class="nf">custom_auto_wrap_policy</span><span class="p">(</span>
<span class="gp">&gt;&gt;&gt; </span>    <span class="n">module</span><span class="p">:</span> <span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">,</span>
<span class="gp">&gt;&gt;&gt; </span>    <span class="n">recurse</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
<span class="gp">&gt;&gt;&gt; </span>    <span class="n">unwrapped_params</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
<span class="gp">&gt;&gt;&gt; </span>    <span class="c1"># These are customizable for this policy function.</span>
<span class="gp">&gt;&gt;&gt; </span>    <span class="n">min_num_params</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mf">1e8</span><span class="p">),</span>
<span class="gp">&gt;&gt;&gt; </span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="gp">&gt;&gt;&gt; </span>    <span class="k">return</span> <span class="n">unwrapped_params</span> <span class="o">&gt;=</span> <span class="n">min_num_params</span>
</pre>
                 </div>
                </div>
               </p>
              </li>
              <li>
               <p>
                <strong>
                 backward_prefetch
                </strong>
                (
                <em>
                 Optional
                </em>
                <em>
                 [
                </em>
                <em>
                 BackwardPrefetch
                </em>
                <em>
                 ]
                </em>
                ) – This is an experimental feature that is subject to change in the
the near future. It allows users to enable two different backward_prefetch
algorithms to help backward communication and computation overlapping.
Pros and cons of each algorithm is explained in the class
                <code class="docutils literal notranslate">
                 <span class="pre">
                  BackwardPrefetch
                 </span>
                </code>
                .
               </p>
              </li>
              <li>
               <p>
                <strong>
                 mixed_precision
                </strong>
                (
                <em>
                 Optional
                </em>
                <em>
                 [
                </em>
                <em>
                 MixedPrecision
                </em>
                <em>
                 ]
                </em>
                ) – A
                <code class="docutils literal notranslate">
                 <span class="pre">
                  MixedPrecision
                 </span>
                </code>
                instance
describing the mixed precision training config to be used.
                <code class="docutils literal notranslate">
                 <span class="pre">
                  MixedPrecision
                 </span>
                </code>
                supports configuring parameter, buffer, and gradient communication dtype. Note
that only floating point data is cast to the reduced precision. This allows
users potential memory saving and training speedup while trading off
accuracy during model training. If
                <code class="docutils literal notranslate">
                 <span class="pre">
                  None
                 </span>
                </code>
                , no mixed precision is applied.
Note that if
                <code class="docutils literal notranslate">
                 <span class="pre">
                  mixed_precision
                 </span>
                </code>
                is enabled for FSDP model that
contains
                <code class="docutils literal notranslate">
                 <span class="pre">
                  BatchNorm
                 </span>
                </code>
                with
                <code class="docutils literal notranslate">
                 <span class="pre">
                  auto_wrap_policy
                 </span>
                </code>
                , FSDP will take
care to disable mixed precision for
                <code class="docutils literal notranslate">
                 <span class="pre">
                  BatchNorm
                 </span>
                </code>
                units by wrapping
them separately in their own FSDP unit with
                <code class="docutils literal notranslate">
                 <span class="pre">
                  mixed_precision=None
                 </span>
                </code>
                .
This is done because several
                <code class="docutils literal notranslate">
                 <span class="pre">
                  BatchNorm
                 </span>
                </code>
                kernels do not implement
reduced type support at the moment. If individually wrapping the model,
users must take care to set
                <code class="docutils literal notranslate">
                 <span class="pre">
                  mixed_precision=None
                 </span>
                </code>
                for
                <code class="docutils literal notranslate">
                 <span class="pre">
                  BatchNorm
                 </span>
                </code>
                units.
(Default:
                <code class="docutils literal notranslate">
                 <span class="pre">
                  None
                 </span>
                </code>
                )
               </p>
              </li>
              <li>
               <p>
                <strong>
                 ignored_modules
                </strong>
                (
                <em>
                 Optional
                </em>
                <em>
                 [
                </em>
                <em>
                 Iterable
                </em>
                <em>
                 [
                </em>
                <a class="reference internal" href="generated/torch.nn.Module.html#torch.nn.Module" title="torch.nn.Module">
                 <em>
                  torch.nn.Module
                 </em>
                </a>
                <em>
                 ]
                </em>
                <em>
                 ]
                </em>
                ) – Modules whose
own parameters and child modules’ parameters and buffers are
ignored by this instance. None of the modules directly in
                <code class="docutils literal notranslate">
                 <span class="pre">
                  ignored_modules
                 </span>
                </code>
                should be
                <a class="reference internal" href="#torch.distributed.fsdp.FullyShardedDataParallel" title="torch.distributed.fsdp.FullyShardedDataParallel">
                 <code class="xref py py-class docutils literal notranslate">
                  <span class="pre">
                   FullyShardedDataParallel
                  </span>
                 </code>
                </a>
                instances, and any child modules that are already-constructed
                <a class="reference internal" href="#torch.distributed.fsdp.FullyShardedDataParallel" title="torch.distributed.fsdp.FullyShardedDataParallel">
                 <code class="xref py py-class docutils literal notranslate">
                  <span class="pre">
                   FullyShardedDataParallel
                  </span>
                 </code>
                </a>
                instances will not be ignored if
they are nested under this instance. This argument may be used to
avoid sharding specific parameters when using an
                <code class="docutils literal notranslate">
                 <span class="pre">
                  auto_wrap_policy
                 </span>
                </code>
                or if parameters’ sharding is not managed by
FSDP. (Default:
                <code class="docutils literal notranslate">
                 <span class="pre">
                  None
                 </span>
                </code>
                )
               </p>
              </li>
              <li>
               <p>
                <strong>
                 param_init_fn
                </strong>
                (
                <em>
                 Optional
                </em>
                <em>
                 [
                </em>
                <em>
                 Callable
                </em>
                <em>
                 [
                </em>
                <em>
                 [
                </em>
                <a class="reference internal" href="generated/torch.nn.Module.html#torch.nn.Module" title="torch.nn.Module">
                 <em>
                  nn.Module
                 </em>
                </a>
                <em>
                 ]
                </em>
                <em>
                 ,
                </em>
                <a class="reference external" href="https://docs.python.org/3/library/constants.html#None" title="(in Python v3.10)">
                 <em>
                  None
                 </em>
                </a>
                <em>
                 ]
                </em>
                <em>
                 ]
                </em>
                ) –
                <p>
                 A
                 <code class="docutils literal notranslate">
                  <span class="pre">
                   Callable[torch.nn.Module]
                  </span>
                  <span class="pre">
                   -&gt;
                  </span>
                  <span class="pre">
                   None
                  </span>
                 </code>
                 that
specifies how modules that are currently on the meta device should be initialized
onto an actual device. Note that as of v1.12, we detect modules on the meta
device via
                 <code class="docutils literal notranslate">
                  <span class="pre">
                   is_meta
                  </span>
                 </code>
                 check and apply a default initialization that calls
                 <code class="docutils literal notranslate">
                  <span class="pre">
                   reset_parameters
                  </span>
                 </code>
                 method on the passed in
                 <code class="docutils literal notranslate">
                  <span class="pre">
                   nn.Module
                  </span>
                 </code>
                 if
                 <code class="docutils literal notranslate">
                  <span class="pre">
                   param_init_fn
                  </span>
                 </code>
                 is not specified, otherwise we run
                 <code class="docutils literal notranslate">
                  <span class="pre">
                   param_init_fn
                  </span>
                 </code>
                 to initialize the passed
in
                 <code class="docutils literal notranslate">
                  <span class="pre">
                   nn.Module
                  </span>
                 </code>
                 . In particular, this means that if
                 <code class="docutils literal notranslate">
                  <span class="pre">
                   is_meta=True
                  </span>
                 </code>
                 for any
module parameters for modules that will be wrapped with FSDP and
                 <code class="docutils literal notranslate">
                  <span class="pre">
                   param_init_fn
                  </span>
                 </code>
                 is not specified, we assume your module properly implements a
                 <code class="docutils literal notranslate">
                  <span class="pre">
                   reset_paramters()
                  </span>
                 </code>
                 and will throw errors if not. Note that additionally, we offer support for modules
initialized with torchdistX’s (
                 <a class="reference external" href="https://github.com/pytorch/torchdistX">
                  https://github.com/pytorch/torchdistX
                 </a>
                 )
                 <code class="docutils literal notranslate">
                  <span class="pre">
                   deferred_init
                  </span>
                 </code>
                 API. In this case, deferred modules would be initialized
by a default initialization function that calls torchdistX’s
                 <code class="docutils literal notranslate">
                  <span class="pre">
                   materialize_module
                  </span>
                 </code>
                 , or the passed in
                 <code class="docutils literal notranslate">
                  <span class="pre">
                   param_init_fn
                  </span>
                 </code>
                 , if it is not
                 <code class="docutils literal notranslate">
                  <span class="pre">
                   None
                  </span>
                 </code>
                 . The same
                 <code class="docutils literal notranslate">
                  <span class="pre">
                   Callable
                  </span>
                 </code>
                 is applied to initialize all meta modules.
Note that this initialization function is applied before doing any FSDP sharding
logic.
                </p>
                <p>
                 Example:
                </p>
                <div class="highlight-default notranslate">
                 <div class="highlight">
                  <pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">module</span> <span class="o">=</span> <span class="n">MyModule</span><span class="p">(</span><span class="n">device</span><span class="o">=</span><span class="s2">"meta"</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">def</span> <span class="nf">my_init_fn</span><span class="p">(</span><span class="n">module</span><span class="p">):</span>
<span class="gp">&gt;&gt;&gt; </span>    <span class="c1"># responsible for initializing a module, such as with reset_parameters</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">fsdp_model</span> <span class="o">=</span> <span class="n">FSDP</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">param_init_fn</span><span class="o">=</span><span class="n">my_init_fn</span><span class="p">,</span> <span class="n">auto_wrap_policy</span><span class="o">=</span><span class="n">size_based_auto_wrap_policy</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="n">fsdp_model</span><span class="o">.</span><span class="n">parameters</span><span class="p">())</span><span class="o">.</span><span class="n">device</span><span class="p">)</span> <span class="c1"># current CUDA device</span>
<span class="gp">&gt;&gt;&gt; </span><span class="c1"># With torchdistX</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">module</span> <span class="o">=</span> <span class="n">deferred_init</span><span class="o">.</span><span class="n">deferred_init</span><span class="p">(</span><span class="n">MyModule</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="s2">"cuda"</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="c1"># Will initialize via deferred_init.materialize_module().</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">fsdp_model</span> <span class="o">=</span> <span class="n">FSDP</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">auto_wrap_policy</span><span class="o">=</span><span class="n">size_based_auto_wrap_policy</span><span class="p">)</span>
</pre>
                 </div>
                </div>
               </p>
              </li>
              <li>
               <p>
                <strong>
                 device_id
                </strong>
                (
                <em>
                 Optional
                </em>
                <em>
                 [
                </em>
                <em>
                 Union
                </em>
                <em>
                 [
                </em>
                <a class="reference external" href="https://docs.python.org/3/library/functions.html#int" title="(in Python v3.10)">
                 <em>
                  int
                 </em>
                </a>
                <em>
                 ,
                </em>
                <a class="reference internal" href="tensor_attributes.html#torch.device" title="torch.device">
                 <em>
                  torch.device
                 </em>
                </a>
                <em>
                 ]
                </em>
                <em>
                 ]
                </em>
                ) – An
                <code class="docutils literal notranslate">
                 <span class="pre">
                  int
                 </span>
                </code>
                or
                <code class="docutils literal notranslate">
                 <span class="pre">
                  torch.device
                 </span>
                </code>
                describing the CUDA device the FSDP module should be moved to determining where
initialization such as sharding takes place. If this argument is not specified
and
                <code class="docutils literal notranslate">
                 <span class="pre">
                  module
                 </span>
                </code>
                is on CPU, we will move
                <code class="docutils literal notranslate">
                 <span class="pre">
                  module
                 </span>
                </code>
                to current CUDA device for faster
initialization and move
                <code class="docutils literal notranslate">
                 <span class="pre">
                  module
                 </span>
                </code>
                back to CPU before returning.
If specified, resulting FSDP instances will reside on this device.
Note that if
                <code class="docutils literal notranslate">
                 <span class="pre">
                  device_id
                 </span>
                </code>
                is specified but
                <code class="docutils literal notranslate">
                 <span class="pre">
                  module
                 </span>
                </code>
                is already
on a different CUDA device, an error will be thrown. (Default:
                <code class="docutils literal notranslate">
                 <span class="pre">
                  None
                 </span>
                </code>
                )
               </p>
              </li>
              <li>
               <p>
                <strong>
                 sync_module_states
                </strong>
                (
                <a class="reference external" href="https://docs.python.org/3/library/functions.html#bool" title="(in Python v3.10)">
                 <em>
                  bool
                 </em>
                </a>
                ) – If
                <code class="docutils literal notranslate">
                 <span class="pre">
                  True
                 </span>
                </code>
                , each individually wrapped FSDP unit will broadcast
module parameters from rank 0 to ensure they are the same across all ranks after
initialization. This helps ensure model parameters are the same across ranks
before starting training, but adds communication overhead to
                <code class="docutils literal notranslate">
                 <span class="pre">
                  __init__
                 </span>
                </code>
                , as at least
one broadcast is triggered per individually wrapped FSDP unit.
This can also help load checkpoints taken by
                <code class="docutils literal notranslate">
                 <span class="pre">
                  state_dict
                 </span>
                </code>
                and to be loaded by
                <code class="docutils literal notranslate">
                 <span class="pre">
                  load_state_dict
                 </span>
                </code>
                in a memory efficient way. See documentation for
                <code class="xref py py-class docutils literal notranslate">
                 <span class="pre">
                  FullStateDictConfig
                 </span>
                </code>
                for an example of this. (Default:
                <code class="docutils literal notranslate">
                 <span class="pre">
                  False
                 </span>
                </code>
                )
               </p>
              </li>
             </ul>
            </dd>
           </dl>
           <dl class="py method">
            <dt id="torch.distributed.fsdp.FullyShardedDataParallel.apply">
             <code class="sig-name descname">
              <span class="pre">
               apply
              </span>
             </code>
             <span class="sig-paren">
              (
             </span>
             <em class="sig-param">
              <span class="n">
               <span class="pre">
                fn
               </span>
              </span>
             </em>
             <span class="sig-paren">
              )
             </span>
             <a class="reference internal" href="_modules/torch/distributed/fsdp/fully_sharded_data_parallel.html#FullyShardedDataParallel.apply">
              <span class="viewcode-link">
               <span class="pre">
                [source]
               </span>
              </span>
             </a>
             <a class="headerlink" href="#torch.distributed.fsdp.FullyShardedDataParallel.apply" title="Permalink to this definition">
              ¶
             </a>
            </dt>
            <dd>
             <p>
              Applies
              <code class="docutils literal notranslate">
               <span class="pre">
                fn
               </span>
              </code>
              recursively to every submodule (as returned by
              <code class="docutils literal notranslate">
               <span class="pre">
                .children()
               </span>
              </code>
              )
as well as self. Typical use includes initializing the parameters of a model
(see also
              <a class="reference internal" href="nn.init.html#nn-init-doc">
               <span class="std std-ref">
                torch.nn.init
               </span>
              </a>
              ).
             </p>
             <p>
              Compared to
              <code class="docutils literal notranslate">
               <span class="pre">
                torch.nn.Module.apply
               </span>
              </code>
              , this version additionally gathers
the full parameters before applying
              <code class="docutils literal notranslate">
               <span class="pre">
                fn
               </span>
              </code>
              . It should not be called from
within another
              <code class="docutils literal notranslate">
               <span class="pre">
                summon_full_params
               </span>
              </code>
              context.
             </p>
             <dl class="field-list simple">
              <dt class="field-odd">
               Parameters
              </dt>
              <dd class="field-odd">
               <p>
                <strong>
                 fn
                </strong>
                (
                <code class="xref py py-class docutils literal notranslate">
                 <span class="pre">
                  Module
                 </span>
                </code>
                -&gt; None) – function to be applied to each submodule
               </p>
              </dd>
              <dt class="field-even">
               Returns
              </dt>
              <dd class="field-even">
               <p>
                self
               </p>
              </dd>
              <dt class="field-odd">
               Return type
              </dt>
              <dd class="field-odd">
               <p>
                <p id="torch.nn.Module">
                </p>
                <a class="reference internal" href="generated/torch.nn.Module.html#torch.nn.Module" title="torch.nn.Module">
                 Module
                </a>
               </p>
              </dd>
             </dl>
            </dd>
           </dl>
           <dl class="py method">
            <dt id="torch.distributed.fsdp.FullyShardedDataParallel.clip_grad_norm_">
             <code class="sig-name descname">
              <span class="pre">
               clip_grad_norm_
              </span>
             </code>
             <span class="sig-paren">
              (
             </span>
             <em class="sig-param">
              <span class="n">
               <span class="pre">
                max_norm
               </span>
              </span>
             </em>
             ,
             <em class="sig-param">
              <span class="n">
               <span class="pre">
                norm_type
               </span>
              </span>
              <span class="o">
               <span class="pre">
                =
               </span>
              </span>
              <span class="default_value">
               <span class="pre">
                2.0
               </span>
              </span>
             </em>
             <span class="sig-paren">
              )
             </span>
             <a class="reference internal" href="_modules/torch/distributed/fsdp/fully_sharded_data_parallel.html#FullyShardedDataParallel.clip_grad_norm_">
              <span class="viewcode-link">
               <span class="pre">
                [source]
               </span>
              </span>
             </a>
             <a class="headerlink" href="#torch.distributed.fsdp.FullyShardedDataParallel.clip_grad_norm_" title="Permalink to this definition">
              ¶
             </a>
            </dt>
            <dd>
             <p>
              Clip all gradients at this point in time. The norm is computed over all
gradients together, as if they were concatenated into a single vector.
Gradients are modified in-place.
             </p>
             <dl class="field-list simple">
              <dt class="field-odd">
               Parameters
              </dt>
              <dd class="field-odd">
               <ul class="simple">
                <li>
                 <p>
                  <strong>
                   max_norm
                  </strong>
                  (
                  <a class="reference external" href="https://docs.python.org/3/library/functions.html#float" title="(in Python v3.10)">
                   <em>
                    float
                   </em>
                  </a>
                  <em>
                   or
                  </em>
                  <a class="reference external" href="https://docs.python.org/3/library/functions.html#int" title="(in Python v3.10)">
                   <em>
                    int
                   </em>
                  </a>
                  ) – max norm of the gradients
                 </p>
                </li>
                <li>
                 <p>
                  <strong>
                   norm_type
                  </strong>
                  (
                  <a class="reference external" href="https://docs.python.org/3/library/functions.html#float" title="(in Python v3.10)">
                   <em>
                    float
                   </em>
                  </a>
                  <em>
                   or
                  </em>
                  <a class="reference external" href="https://docs.python.org/3/library/functions.html#int" title="(in Python v3.10)">
                   <em>
                    int
                   </em>
                  </a>
                  ) – type of the used p-norm. Can be
                  <code class="docutils literal notranslate">
                   <span class="pre">
                    'inf'
                   </span>
                  </code>
                  for infinity norm.
                 </p>
                </li>
               </ul>
              </dd>
              <dt class="field-even">
               Returns
              </dt>
              <dd class="field-even">
               <p>
                Total norm of the parameters (viewed as a single vector).
               </p>
              </dd>
             </dl>
             <div class="admonition note">
              <p class="admonition-title">
               Note
              </p>
              <p>
               This is analogous to
               <code class="docutils literal notranslate">
                <span class="pre">
                 torch.nn.utils.clip_grad_norm_
                </span>
               </code>
               but
handles the partitioning and multiple devices per rank under the
hood. The default torch util is not applicable here, because each
rank only has a partial view of all the grads in the model, so
calling it for FSDP models would lead to different scaling being
applied per subset of model parameters.
              </p>
             </div>
             <div class="admonition warning">
              <p class="admonition-title">
               Warning
              </p>
              <p>
               This needs to be called on all ranks, since synchronization
primitives will be used.
              </p>
             </div>
            </dd>
           </dl>
           <dl class="py method">
            <dt id="torch.distributed.fsdp.FullyShardedDataParallel.fsdp_modules">
             <em class="property">
              <span class="pre">
               static
              </span>
             </em>
             <code class="sig-name descname">
              <span class="pre">
               fsdp_modules
              </span>
             </code>
             <span class="sig-paren">
              (
             </span>
             <em class="sig-param">
              <span class="n">
               <span class="pre">
                module
               </span>
              </span>
             </em>
             ,
             <em class="sig-param">
              <span class="n">
               <span class="pre">
                root_only
               </span>
              </span>
              <span class="o">
               <span class="pre">
                =
               </span>
              </span>
              <span class="default_value">
               <span class="pre">
                False
               </span>
              </span>
             </em>
             <span class="sig-paren">
              )
             </span>
             <a class="reference internal" href="_modules/torch/distributed/fsdp/fully_sharded_data_parallel.html#FullyShardedDataParallel.fsdp_modules">
              <span class="viewcode-link">
               <span class="pre">
                [source]
               </span>
              </span>
             </a>
             <a class="headerlink" href="#torch.distributed.fsdp.FullyShardedDataParallel.fsdp_modules" title="Permalink to this definition">
              ¶
             </a>
            </dt>
            <dd>
             <p>
              Returns all nested FSDP instances, possibly including
              <code class="docutils literal notranslate">
               <span class="pre">
                module
               </span>
              </code>
              itself
and only including FSDP root modules if
              <code class="docutils literal notranslate">
               <span class="pre">
                root_only=True
               </span>
              </code>
              .
             </p>
             <dl class="field-list simple">
              <dt class="field-odd">
               Parameters
              </dt>
              <dd class="field-odd">
               <ul class="simple">
                <li>
                 <p>
                  <strong>
                   module
                  </strong>
                  (
                  <a class="reference internal" href="generated/torch.nn.Module.html#torch.nn.Module" title="torch.nn.Module">
                   <em>
                    torch.nn.Module
                   </em>
                  </a>
                  ) – Root module, which may or may not be an
                  <code class="docutils literal notranslate">
                   <span class="pre">
                    FSDP
                   </span>
                  </code>
                  module.
                 </p>
                </li>
                <li>
                 <p>
                  <strong>
                   root_only
                  </strong>
                  (
                  <a class="reference external" href="https://docs.python.org/3/library/functions.html#bool" title="(in Python v3.10)">
                   <em>
                    bool
                   </em>
                  </a>
                  ) – Whether to return only FSDP root modules.
(Default:
                  <code class="docutils literal notranslate">
                   <span class="pre">
                    False
                   </span>
                  </code>
                  )
                 </p>
                </li>
               </ul>
              </dd>
              <dt class="field-even">
               Returns
              </dt>
              <dd class="field-even">
               <p>
                FSDP modules that are nested in
the input
                <code class="docutils literal notranslate">
                 <span class="pre">
                  module
                 </span>
                </code>
                .
               </p>
              </dd>
              <dt class="field-odd">
               Return type
              </dt>
              <dd class="field-odd">
               <p>
                List[
                <a class="reference internal" href="#torch.distributed.fsdp.FullyShardedDataParallel" title="torch.distributed.fsdp.FullyShardedDataParallel">
                 FullyShardedDataParallel
                </a>
                ]
               </p>
              </dd>
             </dl>
            </dd>
           </dl>
           <dl class="py method">
            <dt id="torch.distributed.fsdp.FullyShardedDataParallel.full_optim_state_dict">
             <em class="property">
              <span class="pre">
               static
              </span>
             </em>
             <code class="sig-name descname">
              <span class="pre">
               full_optim_state_dict
              </span>
             </code>
             <span class="sig-paren">
              (
             </span>
             <em class="sig-param">
              <span class="n">
               <span class="pre">
                model
               </span>
              </span>
             </em>
             ,
             <em class="sig-param">
              <span class="n">
               <span class="pre">
                optim
               </span>
              </span>
             </em>
             ,
             <em class="sig-param">
              <span class="n">
               <span class="pre">
                optim_input
               </span>
              </span>
              <span class="o">
               <span class="pre">
                =
               </span>
              </span>
              <span class="default_value">
               <span class="pre">
                None
               </span>
              </span>
             </em>
             ,
             <em class="sig-param">
              <span class="n">
               <span class="pre">
                rank0_only
               </span>
              </span>
              <span class="o">
               <span class="pre">
                =
               </span>
              </span>
              <span class="default_value">
               <span class="pre">
                True
               </span>
              </span>
             </em>
             <span class="sig-paren">
              )
             </span>
             <a class="reference internal" href="_modules/torch/distributed/fsdp/fully_sharded_data_parallel.html#FullyShardedDataParallel.full_optim_state_dict">
              <span class="viewcode-link">
               <span class="pre">
                [source]
               </span>
              </span>
             </a>
             <a class="headerlink" href="#torch.distributed.fsdp.FullyShardedDataParallel.full_optim_state_dict" title="Permalink to this definition">
              ¶
             </a>
            </dt>
            <dd>
             <p>
              Consolidates the full optimizer state on rank 0 and returns it
as a
              <a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#dict" title="(in Python v3.10)">
               <code class="xref py py-class docutils literal notranslate">
                <span class="pre">
                 dict
                </span>
               </code>
              </a>
              following the convention of
              <a class="reference internal" href="generated/torch.optim.Optimizer.state_dict.html#torch.optim.Optimizer.state_dict" title="torch.optim.Optimizer.state_dict">
               <code class="xref py py-meth docutils literal notranslate">
                <span class="pre">
                 torch.optim.Optimizer.state_dict()
                </span>
               </code>
              </a>
              , i.e. with keys
              <code class="docutils literal notranslate">
               <span class="pre">
                "state"
               </span>
              </code>
              and
              <code class="docutils literal notranslate">
               <span class="pre">
                "param_groups"
               </span>
              </code>
              . The flattened parameters in
              <code class="docutils literal notranslate">
               <span class="pre">
                FSDP
               </span>
              </code>
              modules
contained in
              <code class="docutils literal notranslate">
               <span class="pre">
                model
               </span>
              </code>
              are mapped back to their unflattened parameters.
             </p>
             <div class="admonition warning">
              <p class="admonition-title">
               Warning
              </p>
              <p>
               This needs to be called on all ranks since synchronization
primitives are used. However, if
               <code class="docutils literal notranslate">
                <span class="pre">
                 rank0_only=True
                </span>
               </code>
               , then the
state dict is only populated on rank 0, and all other ranks return
an empty
               <a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#dict" title="(in Python v3.10)">
                <code class="xref py py-class docutils literal notranslate">
                 <span class="pre">
                  dict
                 </span>
                </code>
               </a>
               .
              </p>
             </div>
             <div class="admonition warning">
              <p class="admonition-title">
               Warning
              </p>
              <p>
               Unlike
               <code class="docutils literal notranslate">
                <span class="pre">
                 torch.optim.Optimizer.state_dict()
                </span>
               </code>
               , this method
uses full parameter names as keys instead of parameter IDs.
              </p>
             </div>
             <div class="admonition warning">
              <p class="admonition-title">
               Warning
              </p>
              <p>
               If you do not pass
               <code class="docutils literal notranslate">
                <span class="pre">
                 model.parameters()
                </span>
               </code>
               as the first
argument to the optimizer, then you should pass that same value to
this method as
               <code class="docutils literal notranslate">
                <span class="pre">
                 optim_input
                </span>
               </code>
               .
              </p>
             </div>
             <div class="admonition note">
              <p class="admonition-title">
               Note
              </p>
              <p>
               Like in
               <a class="reference internal" href="generated/torch.optim.Optimizer.state_dict.html#torch.optim.Optimizer.state_dict" title="torch.optim.Optimizer.state_dict">
                <code class="xref py py-meth docutils literal notranslate">
                 <span class="pre">
                  torch.optim.Optimizer.state_dict()
                 </span>
                </code>
               </a>
               , the tensors
contained in the optimizer state dict are not cloned, so there may
be aliasing surprises. For best practices, consider saving the
returned optimizer state dict immediately, e.g. using
               <code class="docutils literal notranslate">
                <span class="pre">
                 torch.save()
                </span>
               </code>
               .
              </p>
             </div>
             <dl class="field-list simple">
              <dt class="field-odd">
               Parameters
              </dt>
              <dd class="field-odd">
               <ul class="simple">
                <li>
                 <p>
                  <strong>
                   model
                  </strong>
                  (
                  <a class="reference internal" href="generated/torch.nn.Module.html#torch.nn.Module" title="torch.nn.Module">
                   <em>
                    torch.nn.Module
                   </em>
                  </a>
                  ) – Root module (which may or may not be a
                  <a class="reference internal" href="#torch.distributed.fsdp.FullyShardedDataParallel" title="torch.distributed.fsdp.FullyShardedDataParallel">
                   <code class="xref py py-class docutils literal notranslate">
                    <span class="pre">
                     FullyShardedDataParallel
                    </span>
                   </code>
                  </a>
                  instance) whose parameters
were passed into the optimizer
                  <code class="docutils literal notranslate">
                   <span class="pre">
                    optim
                   </span>
                  </code>
                  .
                 </p>
                </li>
                <li>
                 <p>
                  <strong>
                   optim
                  </strong>
                  (
                  <a class="reference internal" href="optim.html#torch.optim.Optimizer" title="torch.optim.Optimizer">
                   <em>
                    torch.optim.Optimizer
                   </em>
                  </a>
                  ) – Optimizer for
                  <code class="docutils literal notranslate">
                   <span class="pre">
                    model
                   </span>
                  </code>
                  ‘s
parameters.
                 </p>
                </li>
                <li>
                 <p>
                  <strong>
                   optim_input
                  </strong>
                  (
                  <em>
                   Optional
                  </em>
                  <em>
                   [
                  </em>
                  <em>
                   Union
                  </em>
                  <em>
                   [
                  </em>
                  <em>
                   List
                  </em>
                  <em>
                   [
                  </em>
                  <em>
                   Dict
                  </em>
                  <em>
                   [
                  </em>
                  <a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.10)">
                   <em>
                    str
                   </em>
                  </a>
                  <em>
                   ,
                  </em>
                  <em>
                   Any
                  </em>
                  <em>
                   ]
                  </em>
                  <em>
                   ]
                  </em>
                  <em>
                   ,
                  </em>
                  <em>
                   Iterable
                  </em>
                  <em>
                   [
                  </em>
                  <em>
                   torch.nn.Parameter
                  </em>
                  <em>
                   ]
                  </em>
                  <em>
                   ]
                  </em>
                  <em>
                   ]
                  </em>
                  ) – Input passed into the optimizer
                  <code class="docutils literal notranslate">
                   <span class="pre">
                    optim
                   </span>
                  </code>
                  representing either a
                  <a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#list" title="(in Python v3.10)">
                   <code class="xref py py-class docutils literal notranslate">
                    <span class="pre">
                     list
                    </span>
                   </code>
                  </a>
                  of parameter groups or an iterable of parameters;
if
                  <code class="docutils literal notranslate">
                   <span class="pre">
                    None
                   </span>
                  </code>
                  , then this method assumes the input was
                  <code class="docutils literal notranslate">
                   <span class="pre">
                    model.parameters()
                   </span>
                  </code>
                  . (Default:
                  <code class="docutils literal notranslate">
                   <span class="pre">
                    None
                   </span>
                  </code>
                  )
                 </p>
                </li>
                <li>
                 <p>
                  <strong>
                   rank0_only
                  </strong>
                  (
                  <a class="reference external" href="https://docs.python.org/3/library/functions.html#bool" title="(in Python v3.10)">
                   <em>
                    bool
                   </em>
                  </a>
                  ) – If
                  <code class="docutils literal notranslate">
                   <span class="pre">
                    True
                   </span>
                  </code>
                  , saves the populated
                  <a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#dict" title="(in Python v3.10)">
                   <code class="xref py py-class docutils literal notranslate">
                    <span class="pre">
                     dict
                    </span>
                   </code>
                  </a>
                  only on rank 0; if
                  <code class="docutils literal notranslate">
                   <span class="pre">
                    False
                   </span>
                  </code>
                  , saves it on all ranks. (Default:
                  <code class="docutils literal notranslate">
                   <span class="pre">
                    True
                   </span>
                  </code>
                  )
                 </p>
                </li>
               </ul>
              </dd>
              <dt class="field-even">
               Returns
              </dt>
              <dd class="field-even">
               <p>
                A
                <a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#dict" title="(in Python v3.10)">
                 <code class="xref py py-class docutils literal notranslate">
                  <span class="pre">
                   dict
                  </span>
                 </code>
                </a>
                containing the optimizer state for
                <code class="docutils literal notranslate">
                 <span class="pre">
                  model
                 </span>
                </code>
                ‘s original unflattened parameters and including keys
“state” and “param_groups” following the convention of
                <a class="reference internal" href="generated/torch.optim.Optimizer.state_dict.html#torch.optim.Optimizer.state_dict" title="torch.optim.Optimizer.state_dict">
                 <code class="xref py py-meth docutils literal notranslate">
                  <span class="pre">
                   torch.optim.Optimizer.state_dict()
                  </span>
                 </code>
                </a>
                . If
                <code class="docutils literal notranslate">
                 <span class="pre">
                  rank0_only=True
                 </span>
                </code>
                ,
then nonzero ranks return an empty
                <a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#dict" title="(in Python v3.10)">
                 <code class="xref py py-class docutils literal notranslate">
                  <span class="pre">
                   dict
                  </span>
                 </code>
                </a>
                .
               </p>
              </dd>
              <dt class="field-odd">
               Return type
              </dt>
              <dd class="field-odd">
               <p>
                Dict[
                <a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.10)">
                 str
                </a>
                , Any]
               </p>
              </dd>
             </dl>
            </dd>
           </dl>
           <dl class="py method">
            <dt id="torch.distributed.fsdp.FullyShardedDataParallel.load_state_dict">
             <code class="sig-name descname">
              <span class="pre">
               load_state_dict
              </span>
             </code>
             <span class="sig-paren">
              (
             </span>
             <em class="sig-param">
              <span class="n">
               <span class="pre">
                state_dict
               </span>
              </span>
             </em>
             ,
             <em class="sig-param">
              <span class="o">
               <span class="pre">
                *
               </span>
              </span>
              <span class="n">
               <span class="pre">
                args
               </span>
              </span>
             </em>
             <span class="sig-paren">
              )
             </span>
             <a class="reference internal" href="_modules/torch/distributed/fsdp/fully_sharded_data_parallel.html#FullyShardedDataParallel.load_state_dict">
              <span class="viewcode-link">
               <span class="pre">
                [source]
               </span>
              </span>
             </a>
             <a class="headerlink" href="#torch.distributed.fsdp.FullyShardedDataParallel.load_state_dict" title="Permalink to this definition">
              ¶
             </a>
            </dt>
            <dd>
             <p>
              The entry point of all three FSDP
              <code class="docutils literal notranslate">
               <span class="pre">
                load_state_dict
               </span>
              </code>
              APIs. By default,
calling
              <code class="docutils literal notranslate">
               <span class="pre">
                load_state_dict
               </span>
              </code>
              on an FSDP module will result in FSDP
attempting to load a “full” state_dict, i.e. a state_dict consisting of
full, unsharded, unflattened original module parameters. This requires
FSDP to load the full parameter context on each rank which could result
in GPU OOM. As a result,
              <a class="reference internal" href="#torch.distributed.fsdp.FullyShardedDataParallel.state_dict_type" title="torch.distributed.fsdp.FullyShardedDataParallel.state_dict_type">
               <code class="xref py py-func docutils literal notranslate">
                <span class="pre">
                 state_dict_type()
                </span>
               </code>
              </a>
              API is available to
configure between
              <code class="docutils literal notranslate">
               <span class="pre">
                load_state_dict
               </span>
              </code>
              implementations. User can thus use
              <code class="docutils literal notranslate">
               <span class="pre">
                with
               </span>
               <span class="pre">
                self.state_dict_type(self,
               </span>
               <span class="pre">
                StateDictType.LOCAL_STATE_DICT)
               </span>
              </code>
              context
manager to load a local state dict checkpoint that will restore only
local shards of the module. Currently, the only supported
implementations are
              <code class="docutils literal notranslate">
               <span class="pre">
                StateDictType.LOCAL_STATE_DICT
               </span>
              </code>
              and
              <code class="docutils literal notranslate">
               <span class="pre">
                StateDictType.FULL_STATE_DICT
               </span>
              </code>
              (default). Please see
              <a class="reference internal" href="#torch.distributed.fsdp.FullyShardedDataParallel.state_dict" title="torch.distributed.fsdp.FullyShardedDataParallel.state_dict">
               <code class="xref py py-func docutils literal notranslate">
                <span class="pre">
                 state_dict()
                </span>
               </code>
              </a>
              for documentation around creating an FSDP checkpoint.
             </p>
             <p>
              Example:
             </p>
             <div class="highlight-default notranslate">
              <div class="highlight">
               <pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">torch</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">torch.distributed.fsdp</span> <span class="kn">import</span> <span class="n">FullyShardedDataParallel</span> <span class="k">as</span> <span class="n">FSDP</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">torch.distributed.fsdp</span> <span class="kn">import</span> <span class="n">StateDictType</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">set_device</span><span class="p">(</span><span class="n">device_id</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">my_module</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">sharded_module</span> <span class="o">=</span> <span class="n">FSDP</span><span class="p">(</span><span class="n">my_module</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">checkpoint</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">PATH</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">full_state_dict</span> <span class="o">=</span> <span class="n">checkpoint</span><span class="p">[</span><span class="s1">'full_state_dict'</span><span class="p">]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">with</span> <span class="n">FSDP</span><span class="o">.</span><span class="n">state_dict_type</span><span class="p">(</span><span class="n">sharded_module</span><span class="p">,</span> <span class="n">StateDictType</span><span class="o">.</span><span class="n">FULL_STATE_DICT</span><span class="p">):</span>
<span class="gp">&gt;&gt;&gt; </span>    <span class="n">sharded_module</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">full_state_dict</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">full_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">odict_keys</span><span class="p">([</span><span class="s1">'weight'</span><span class="p">,</span> <span class="s1">'bias'</span><span class="p">])</span>
<span class="gp">&gt;&gt;&gt; </span><span class="c1"># using local state dict</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">local_state_dict</span> <span class="o">=</span> <span class="n">checkpoint</span><span class="p">[</span><span class="s1">'local_state_dict'</span><span class="p">]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">with</span> <span class="n">FSDP</span><span class="o">.</span><span class="n">state_dict_type</span><span class="p">(</span><span class="n">sharded_module</span><span class="p">,</span> <span class="n">StateDictType</span><span class="o">.</span><span class="n">LOCAL_STATE_DICT</span><span class="p">):</span>
<span class="gp">&gt;&gt;&gt; </span>    <span class="n">sharded_module</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">local_state_dict</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">local_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">odict_keys</span><span class="p">([</span><span class="s1">'flat_param'</span><span class="p">,</span> <span class="s1">'inner.flat_param'</span><span class="p">])</span>
</pre>
              </div>
             </div>
             <div class="admonition warning">
              <p class="admonition-title">
               Warning
              </p>
              <p>
               This needs to be called on all ranks, since synchronization
primitives may be used.
              </p>
             </div>
            </dd>
           </dl>
           <dl class="py method">
            <dt id="torch.distributed.fsdp.FullyShardedDataParallel.module">
             <em class="property">
              <span class="pre">
               property
              </span>
             </em>
             <code class="sig-name descname">
              <span class="pre">
               module
              </span>
             </code>
             <a class="headerlink" href="#torch.distributed.fsdp.FullyShardedDataParallel.module" title="Permalink to this definition">
              ¶
             </a>
            </dt>
            <dd>
             <p>
              make model.module accessible, just like DDP.
             </p>
            </dd>
           </dl>
           <dl class="py method">
            <dt id="torch.distributed.fsdp.FullyShardedDataParallel.named_buffers">
             <code class="sig-name descname">
              <span class="pre">
               named_buffers
              </span>
             </code>
             <span class="sig-paren">
              (
             </span>
             <em class="sig-param">
              <span class="o">
               <span class="pre">
                *
               </span>
              </span>
              <span class="n">
               <span class="pre">
                args
               </span>
              </span>
             </em>
             ,
             <em class="sig-param">
              <span class="o">
               <span class="pre">
                **
               </span>
              </span>
              <span class="n">
               <span class="pre">
                kwargs
               </span>
              </span>
             </em>
             <span class="sig-paren">
              )
             </span>
             <a class="reference internal" href="_modules/torch/distributed/fsdp/fully_sharded_data_parallel.html#FullyShardedDataParallel.named_buffers">
              <span class="viewcode-link">
               <span class="pre">
                [source]
               </span>
              </span>
             </a>
             <a class="headerlink" href="#torch.distributed.fsdp.FullyShardedDataParallel.named_buffers" title="Permalink to this definition">
              ¶
             </a>
            </dt>
            <dd>
             <p>
              Overrides
              <a class="reference internal" href="#torch.distributed.fsdp.FullyShardedDataParallel.named_buffers" title="torch.distributed.fsdp.FullyShardedDataParallel.named_buffers">
               <code class="xref py py-meth docutils literal notranslate">
                <span class="pre">
                 named_buffers()
                </span>
               </code>
              </a>
              to intercept buffer names and
remove all occurrences of the FSDP-specific flattened buffer prefix
when inside the
              <a class="reference internal" href="#torch.distributed.fsdp.FullyShardedDataParallel.summon_full_params" title="torch.distributed.fsdp.FullyShardedDataParallel.summon_full_params">
               <code class="xref py py-meth docutils literal notranslate">
                <span class="pre">
                 summon_full_params()
                </span>
               </code>
              </a>
              context manager.
             </p>
            </dd>
           </dl>
           <dl class="py method">
            <dt id="torch.distributed.fsdp.FullyShardedDataParallel.named_parameters">
             <code class="sig-name descname">
              <span class="pre">
               named_parameters
              </span>
             </code>
             <span class="sig-paren">
              (
             </span>
             <em class="sig-param">
              <span class="o">
               <span class="pre">
                *
               </span>
              </span>
              <span class="n">
               <span class="pre">
                args
               </span>
              </span>
             </em>
             ,
             <em class="sig-param">
              <span class="o">
               <span class="pre">
                **
               </span>
              </span>
              <span class="n">
               <span class="pre">
                kwargs
               </span>
              </span>
             </em>
             <span class="sig-paren">
              )
             </span>
             <a class="reference internal" href="_modules/torch/distributed/fsdp/fully_sharded_data_parallel.html#FullyShardedDataParallel.named_parameters">
              <span class="viewcode-link">
               <span class="pre">
                [source]
               </span>
              </span>
             </a>
             <a class="headerlink" href="#torch.distributed.fsdp.FullyShardedDataParallel.named_parameters" title="Permalink to this definition">
              ¶
             </a>
            </dt>
            <dd>
             <p>
              Overrides
              <a class="reference internal" href="#torch.distributed.fsdp.FullyShardedDataParallel.named_parameters" title="torch.distributed.fsdp.FullyShardedDataParallel.named_parameters">
               <code class="xref py py-meth docutils literal notranslate">
                <span class="pre">
                 named_parameters()
                </span>
               </code>
              </a>
              to intercept parameter names and
remove all occurrences of the FSDP-specific flattened parameter prefix
when inside the
              <a class="reference internal" href="#torch.distributed.fsdp.FullyShardedDataParallel.summon_full_params" title="torch.distributed.fsdp.FullyShardedDataParallel.summon_full_params">
               <code class="xref py py-meth docutils literal notranslate">
                <span class="pre">
                 summon_full_params()
                </span>
               </code>
              </a>
              context manager.
             </p>
            </dd>
           </dl>
           <dl class="py method">
            <dt id="torch.distributed.fsdp.FullyShardedDataParallel.no_sync">
             <code class="sig-name descname">
              <span class="pre">
               no_sync
              </span>
             </code>
             <span class="sig-paren">
              (
             </span>
             <span class="sig-paren">
              )
             </span>
             <a class="reference internal" href="_modules/torch/distributed/fsdp/fully_sharded_data_parallel.html#FullyShardedDataParallel.no_sync">
              <span class="viewcode-link">
               <span class="pre">
                [source]
               </span>
              </span>
             </a>
             <a class="headerlink" href="#torch.distributed.fsdp.FullyShardedDataParallel.no_sync" title="Permalink to this definition">
              ¶
             </a>
            </dt>
            <dd>
             <p>
              A context manager to disable gradient synchronizations across FSDP
instances. Within this context, gradients will be accumulated in module
variables, which will later be synchronized in the first
forward-backward pass after exiting the context. This should only be
used on the root FSDP instance and will recursively apply to all
children FSDP instances.
             </p>
             <div class="admonition note">
              <p class="admonition-title">
               Note
              </p>
              <p>
               This likely results in higher memory usage because FSDP will
accumulate the full model gradients (instead of gradient shards)
until the eventual sync.
              </p>
             </div>
             <div class="admonition note">
              <p class="admonition-title">
               Note
              </p>
              <p>
               When used with CPU offloading, the gradients will not be
offloaded to CPU when inside the context manager. Instead, they
will only be offloaded right after the eventual sync.
              </p>
             </div>
            </dd>
           </dl>
           <dl class="py method">
            <dt id="torch.distributed.fsdp.FullyShardedDataParallel.params_with_grad">
             <em class="property">
              <span class="pre">
               property
              </span>
             </em>
             <code class="sig-name descname">
              <span class="pre">
               params_with_grad
              </span>
             </code>
             <a class="headerlink" href="#torch.distributed.fsdp.FullyShardedDataParallel.params_with_grad" title="Permalink to this definition">
              ¶
             </a>
            </dt>
            <dd>
             <p>
              Recursively returns a list of all module parameters that have a gradient.
             </p>
            </dd>
           </dl>
           <dl class="py method">
            <dt id="torch.distributed.fsdp.FullyShardedDataParallel.rekey_optim_state_dict">
             <em class="property">
              <span class="pre">
               static
              </span>
             </em>
             <code class="sig-name descname">
              <span class="pre">
               rekey_optim_state_dict
              </span>
             </code>
             <span class="sig-paren">
              (
             </span>
             <em class="sig-param">
              <span class="n">
               <span class="pre">
                optim_state_dict
               </span>
              </span>
             </em>
             ,
             <em class="sig-param">
              <span class="n">
               <span class="pre">
                optim_state_key_type
               </span>
              </span>
             </em>
             ,
             <em class="sig-param">
              <span class="n">
               <span class="pre">
                model
               </span>
              </span>
             </em>
             ,
             <em class="sig-param">
              <span class="n">
               <span class="pre">
                optim_input
               </span>
              </span>
              <span class="o">
               <span class="pre">
                =
               </span>
              </span>
              <span class="default_value">
               <span class="pre">
                None
               </span>
              </span>
             </em>
             <span class="sig-paren">
              )
             </span>
             <a class="reference internal" href="_modules/torch/distributed/fsdp/fully_sharded_data_parallel.html#FullyShardedDataParallel.rekey_optim_state_dict">
              <span class="viewcode-link">
               <span class="pre">
                [source]
               </span>
              </span>
             </a>
             <a class="headerlink" href="#torch.distributed.fsdp.FullyShardedDataParallel.rekey_optim_state_dict" title="Permalink to this definition">
              ¶
             </a>
            </dt>
            <dd>
             <p>
              Re-keys the optimizer state dict
              <code class="docutils literal notranslate">
               <span class="pre">
                optim_state_dict
               </span>
              </code>
              to use the key
type
              <code class="docutils literal notranslate">
               <span class="pre">
                optim_state_key_type
               </span>
              </code>
              . This can be used to achieve
compatibility between optimizer state dicts from models with FSDP
instances and ones without.
             </p>
             <p>
              To re-key an FSDP full optimizer state dict (i.e. from
              <a class="reference internal" href="#torch.distributed.fsdp.FullyShardedDataParallel.full_optim_state_dict" title="torch.distributed.fsdp.FullyShardedDataParallel.full_optim_state_dict">
               <code class="xref py py-meth docutils literal notranslate">
                <span class="pre">
                 full_optim_state_dict()
                </span>
               </code>
              </a>
              ) to use parameter IDs and be loadable to
a non-wrapped model:
             </p>
             <div class="highlight-default notranslate">
              <div class="highlight">
               <pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">wrapped_model</span><span class="p">,</span> <span class="n">wrapped_optim</span> <span class="o">=</span> <span class="o">...</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">full_osd</span> <span class="o">=</span> <span class="n">FSDP</span><span class="o">.</span><span class="n">full_optim_state_dict</span><span class="p">(</span><span class="n">wrapped_model</span><span class="p">,</span> <span class="n">wrapped_optim</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">nonwrapped_model</span><span class="p">,</span> <span class="n">nonwrapped_optim</span> <span class="o">=</span> <span class="o">...</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">rekeyed_osd</span> <span class="o">=</span> <span class="n">FSDP</span><span class="o">.</span><span class="n">rekey_optim_state_dict</span><span class="p">(</span><span class="n">full_osd</span><span class="p">,</span> <span class="n">OptimStateKeyType</span><span class="o">.</span><span class="n">PARAM_ID</span><span class="p">,</span> <span class="n">nonwrapped_model</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">nonwrapped_optim</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">rekeyed_osd</span><span class="p">)</span>
</pre>
              </div>
             </div>
             <p>
              To re-key a normal optimizer state dict from a non-wrapped model to be
loadable to a wrapped model:
             </p>
             <div class="highlight-default notranslate">
              <div class="highlight">
               <pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">nonwrapped_model</span><span class="p">,</span> <span class="n">nonwrapped_optim</span> <span class="o">=</span> <span class="o">...</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">osd</span> <span class="o">=</span> <span class="n">nonwrapped_optim</span><span class="o">.</span><span class="n">state_dict</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">rekeyed_osd</span> <span class="o">=</span> <span class="n">FSDP</span><span class="o">.</span><span class="n">rekey_optim_state_dict</span><span class="p">(</span><span class="n">osd</span><span class="p">,</span> <span class="n">OptimStateKeyType</span><span class="o">.</span><span class="n">PARAM_NAME</span><span class="p">,</span> <span class="n">nonwrapped_model</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">wrapped_model</span><span class="p">,</span> <span class="n">wrapped_optim</span> <span class="o">=</span> <span class="o">...</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">sharded_osd</span> <span class="o">=</span> <span class="n">FSDP</span><span class="o">.</span><span class="n">shard_full_optim_state_dict</span><span class="p">(</span><span class="n">rekeyed_osd</span><span class="p">,</span> <span class="n">wrapped_model</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">wrapped_optim</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">sharded_osd</span><span class="p">)</span>
</pre>
              </div>
             </div>
             <dl class="field-list simple">
              <dt class="field-odd">
               Returns
              </dt>
              <dd class="field-odd">
               <p>
                The optimizer state dict re-keyed using the
parameter keys specified by
                <code class="docutils literal notranslate">
                 <span class="pre">
                  optim_state_key_type
                 </span>
                </code>
                .
               </p>
              </dd>
              <dt class="field-even">
               Return type
              </dt>
              <dd class="field-even">
               <p>
                Dict[
                <a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.10)">
                 str
                </a>
                , Any]
               </p>
              </dd>
             </dl>
            </dd>
           </dl>
           <dl class="py method">
            <dt id="torch.distributed.fsdp.FullyShardedDataParallel.scatter_full_optim_state_dict">
             <em class="property">
              <span class="pre">
               static
              </span>
             </em>
             <code class="sig-name descname">
              <span class="pre">
               scatter_full_optim_state_dict
              </span>
             </code>
             <span class="sig-paren">
              (
             </span>
             <em class="sig-param">
              <span class="n">
               <span class="pre">
                full_optim_state_dict
               </span>
              </span>
             </em>
             ,
             <em class="sig-param">
              <span class="n">
               <span class="pre">
                model
               </span>
              </span>
             </em>
             ,
             <em class="sig-param">
              <span class="n">
               <span class="pre">
                optim_input
               </span>
              </span>
              <span class="o">
               <span class="pre">
                =
               </span>
              </span>
              <span class="default_value">
               <span class="pre">
                None
               </span>
              </span>
             </em>
             ,
             <em class="sig-param">
              <span class="n">
               <span class="pre">
                group
               </span>
              </span>
              <span class="o">
               <span class="pre">
                =
               </span>
              </span>
              <span class="default_value">
               <span class="pre">
                None
               </span>
              </span>
             </em>
             <span class="sig-paren">
              )
             </span>
             <a class="reference internal" href="_modules/torch/distributed/fsdp/fully_sharded_data_parallel.html#FullyShardedDataParallel.scatter_full_optim_state_dict">
              <span class="viewcode-link">
               <span class="pre">
                [source]
               </span>
              </span>
             </a>
             <a class="headerlink" href="#torch.distributed.fsdp.FullyShardedDataParallel.scatter_full_optim_state_dict" title="Permalink to this definition">
              ¶
             </a>
            </dt>
            <dd>
             <p>
              Scatters the full optimizer state dict from rank 0 to all other ranks,
returning the sharded optimizer state dict on each rank. The return
value is the same as
              <a class="reference internal" href="#torch.distributed.fsdp.FullyShardedDataParallel.shard_full_optim_state_dict" title="torch.distributed.fsdp.FullyShardedDataParallel.shard_full_optim_state_dict">
               <code class="xref py py-meth docutils literal notranslate">
                <span class="pre">
                 shard_full_optim_state_dict()
                </span>
               </code>
              </a>
              , and on rank
0, the first argument should be the return value of
              <a class="reference internal" href="#torch.distributed.fsdp.FullyShardedDataParallel.full_optim_state_dict" title="torch.distributed.fsdp.FullyShardedDataParallel.full_optim_state_dict">
               <code class="xref py py-meth docutils literal notranslate">
                <span class="pre">
                 full_optim_state_dict()
                </span>
               </code>
              </a>
              .
             </p>
             <p>
              Example:
             </p>
             <div class="highlight-default notranslate">
              <div class="highlight">
               <pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">torch.distributed.fsdp</span> <span class="kn">import</span> <span class="n">FullyShardedDataParallel</span> <span class="k">as</span> <span class="n">FSDP</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">model</span><span class="p">,</span> <span class="n">optim</span> <span class="o">=</span> <span class="o">...</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">full_osd</span> <span class="o">=</span> <span class="n">FSDP</span><span class="o">.</span><span class="n">full_optim_state_dict</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">optim</span><span class="p">)</span>  <span class="c1"># only non-empty on rank 0</span>
<span class="gp">&gt;&gt;&gt; </span><span class="c1"># Define new model with possibly different world size</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">new_model</span><span class="p">,</span> <span class="n">new_optim</span><span class="p">,</span> <span class="n">new_group</span> <span class="o">=</span> <span class="o">...</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">sharded_osd</span> <span class="o">=</span> <span class="n">FSDP</span><span class="o">.</span><span class="n">scatter_full_optim_state_dict</span><span class="p">(</span><span class="n">full_osd</span><span class="p">,</span> <span class="n">new_model</span><span class="p">,</span> <span class="n">group</span><span class="o">=</span><span class="n">new_group</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">new_optim</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">sharded_osd</span><span class="p">)</span>
</pre>
              </div>
             </div>
             <div class="admonition note">
              <p class="admonition-title">
               Note
              </p>
              <p>
               Both
               <a class="reference internal" href="#torch.distributed.fsdp.FullyShardedDataParallel.shard_full_optim_state_dict" title="torch.distributed.fsdp.FullyShardedDataParallel.shard_full_optim_state_dict">
                <code class="xref py py-meth docutils literal notranslate">
                 <span class="pre">
                  shard_full_optim_state_dict()
                 </span>
                </code>
               </a>
               and
               <a class="reference internal" href="#torch.distributed.fsdp.FullyShardedDataParallel.scatter_full_optim_state_dict" title="torch.distributed.fsdp.FullyShardedDataParallel.scatter_full_optim_state_dict">
                <code class="xref py py-meth docutils literal notranslate">
                 <span class="pre">
                  scatter_full_optim_state_dict()
                 </span>
                </code>
               </a>
               may be used to get the
sharded optimizer state dict to load. Assuming that the full
optimizer state dict resides in CPU memory, the former requires
each rank to have the full dict in CPU memory, where each rank
individually shards the dict without any communication, while the
latter requires only rank 0 to have the full dict in CPU memory,
where rank 0 moves each shard to GPU memory (for NCCL) and
communicates it to ranks appropriately. Hence, the former has
higher aggregate CPU memory cost, while the latter has higher
communication cost.
              </p>
             </div>
             <dl class="field-list simple">
              <dt class="field-odd">
               Parameters
              </dt>
              <dd class="field-odd">
               <ul class="simple">
                <li>
                 <p>
                  <strong>
                   full_optim_state_dict
                  </strong>
                  (
                  <em>
                   Optional
                  </em>
                  <em>
                   [
                  </em>
                  <em>
                   Dict
                  </em>
                  <em>
                   [
                  </em>
                  <a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.10)">
                   <em>
                    str
                   </em>
                  </a>
                  <em>
                   ,
                  </em>
                  <em>
                   Any
                  </em>
                  <em>
                   ]
                  </em>
                  <em>
                   ]
                  </em>
                  ) – Optimizer state
dict corresponding to the unflattened parameters and holding
the full non-sharded optimizer state if on rank 0; the argument
is ignored on nonzero ranks.
                 </p>
                </li>
                <li>
                 <p>
                  <strong>
                   model
                  </strong>
                  (
                  <a class="reference internal" href="generated/torch.nn.Module.html#torch.nn.Module" title="torch.nn.Module">
                   <em>
                    torch.nn.Module
                   </em>
                  </a>
                  ) – Root module (which may or may not be a
                  <a class="reference internal" href="#torch.distributed.fsdp.FullyShardedDataParallel" title="torch.distributed.fsdp.FullyShardedDataParallel">
                   <code class="xref py py-class docutils literal notranslate">
                    <span class="pre">
                     FullyShardedDataParallel
                    </span>
                   </code>
                  </a>
                  instance) whose parameters
correspond to the optimizer state in
                  <code class="docutils literal notranslate">
                   <span class="pre">
                    full_optim_state_dict
                   </span>
                  </code>
                  .
                 </p>
                </li>
                <li>
                 <p>
                  <strong>
                   optim_input
                  </strong>
                  (
                  <em>
                   Optional
                  </em>
                  <em>
                   [
                  </em>
                  <em>
                   Union
                  </em>
                  <em>
                   [
                  </em>
                  <em>
                   List
                  </em>
                  <em>
                   [
                  </em>
                  <em>
                   Dict
                  </em>
                  <em>
                   [
                  </em>
                  <a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.10)">
                   <em>
                    str
                   </em>
                  </a>
                  <em>
                   ,
                  </em>
                  <em>
                   Any
                  </em>
                  <em>
                   ]
                  </em>
                  <em>
                   ]
                  </em>
                  <em>
                   ,
                  </em>
                  <em>
                   Iterable
                  </em>
                  <em>
                   [
                  </em>
                  <em>
                   torch.nn.Parameter
                  </em>
                  <em>
                   ]
                  </em>
                  <em>
                   ]
                  </em>
                  <em>
                   ]
                  </em>
                  ) – Input passed into the optimizer representing either a
                  <a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#list" title="(in Python v3.10)">
                   <code class="xref py py-class docutils literal notranslate">
                    <span class="pre">
                     list
                    </span>
                   </code>
                  </a>
                  of parameter groups or an iterable of parameters;
if
                  <code class="docutils literal notranslate">
                   <span class="pre">
                    None
                   </span>
                  </code>
                  , then this method assumes the input was
                  <code class="docutils literal notranslate">
                   <span class="pre">
                    model.parameters()
                   </span>
                  </code>
                  ; the argument is ignored on nonzero
ranks. (Default:
                  <code class="docutils literal notranslate">
                   <span class="pre">
                    None
                   </span>
                  </code>
                  )
                 </p>
                </li>
                <li>
                 <p>
                  <strong>
                   group
                  </strong>
                  (
                  <em>
                   Optional
                  </em>
                  <em>
                   [
                  </em>
                  <em>
                   Any
                  </em>
                  <em>
                   ]
                  </em>
                  ) – Model’s process group or
                  <code class="docutils literal notranslate">
                   <span class="pre">
                    None
                   </span>
                  </code>
                  if using
the default process group. (Default:
                  <code class="docutils literal notranslate">
                   <span class="pre">
                    None
                   </span>
                  </code>
                  )
                 </p>
                </li>
               </ul>
              </dd>
              <dt class="field-even">
               Returns
              </dt>
              <dd class="field-even">
               <p>
                The full optimizer state dict now remapped to
flattened parameters instead of unflattened parameters and
restricted to only include this rank’s part of the optimizer state.
               </p>
              </dd>
              <dt class="field-odd">
               Return type
              </dt>
              <dd class="field-odd">
               <p>
                Dict[
                <a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.10)">
                 str
                </a>
                , Any]
               </p>
              </dd>
             </dl>
            </dd>
           </dl>
           <dl class="py method">
            <dt id="torch.distributed.fsdp.FullyShardedDataParallel.shard_full_optim_state_dict">
             <em class="property">
              <span class="pre">
               static
              </span>
             </em>
             <code class="sig-name descname">
              <span class="pre">
               shard_full_optim_state_dict
              </span>
             </code>
             <span class="sig-paren">
              (
             </span>
             <em class="sig-param">
              <span class="n">
               <span class="pre">
                full_optim_state_dict
               </span>
              </span>
             </em>
             ,
             <em class="sig-param">
              <span class="n">
               <span class="pre">
                model
               </span>
              </span>
             </em>
             ,
             <em class="sig-param">
              <span class="n">
               <span class="pre">
                optim_input
               </span>
              </span>
              <span class="o">
               <span class="pre">
                =
               </span>
              </span>
              <span class="default_value">
               <span class="pre">
                None
               </span>
              </span>
             </em>
             <span class="sig-paren">
              )
             </span>
             <a class="reference internal" href="_modules/torch/distributed/fsdp/fully_sharded_data_parallel.html#FullyShardedDataParallel.shard_full_optim_state_dict">
              <span class="viewcode-link">
               <span class="pre">
                [source]
               </span>
              </span>
             </a>
             <a class="headerlink" href="#torch.distributed.fsdp.FullyShardedDataParallel.shard_full_optim_state_dict" title="Permalink to this definition">
              ¶
             </a>
            </dt>
            <dd>
             <p>
              Shards the full optimizer state dict
              <code class="docutils literal notranslate">
               <span class="pre">
                full_optim_state_dict
               </span>
              </code>
              by
remapping the state to flattened parameters instead of unflattened
parameters and restricting to only this rank’s part of the optimizer
state. The first argument should be the return value of
              <a class="reference internal" href="#torch.distributed.fsdp.FullyShardedDataParallel.full_optim_state_dict" title="torch.distributed.fsdp.FullyShardedDataParallel.full_optim_state_dict">
               <code class="xref py py-meth docutils literal notranslate">
                <span class="pre">
                 full_optim_state_dict()
                </span>
               </code>
              </a>
              .
             </p>
             <p>
              Example:
             </p>
             <div class="highlight-default notranslate">
              <div class="highlight">
               <pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">torch.distributed.fsdp</span> <span class="kn">import</span> <span class="n">FullyShardedDataParallel</span> <span class="k">as</span> <span class="n">FSDP</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">model</span><span class="p">,</span> <span class="n">optim</span> <span class="o">=</span> <span class="o">...</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">full_osd</span> <span class="o">=</span> <span class="n">FSDP</span><span class="o">.</span><span class="n">full_optim_state_dict</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">optim</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">torch</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">full_osd</span><span class="p">,</span> <span class="n">PATH</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="c1"># Define new model with possibly different world size</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">new_model</span><span class="p">,</span> <span class="n">new_optim</span> <span class="o">=</span> <span class="o">...</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">full_osd</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">PATH</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">sharded_osd</span> <span class="o">=</span> <span class="n">FSDP</span><span class="o">.</span><span class="n">shard_full_optim_state_dict</span><span class="p">(</span><span class="n">full_osd</span><span class="p">,</span> <span class="n">new_model</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">new_optim</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">sharded_osd</span><span class="p">)</span>
</pre>
              </div>
             </div>
             <div class="admonition warning">
              <p class="admonition-title">
               Warning
              </p>
              <p>
               If you do not pass
               <code class="docutils literal notranslate">
                <span class="pre">
                 model.parameters()
                </span>
               </code>
               as the first
argument to the optimizer, then you should pass that same value to
this method as
               <code class="docutils literal notranslate">
                <span class="pre">
                 optim_input
                </span>
               </code>
               .
              </p>
             </div>
             <div class="admonition note">
              <p class="admonition-title">
               Note
              </p>
              <p>
               Both
               <a class="reference internal" href="#torch.distributed.fsdp.FullyShardedDataParallel.shard_full_optim_state_dict" title="torch.distributed.fsdp.FullyShardedDataParallel.shard_full_optim_state_dict">
                <code class="xref py py-meth docutils literal notranslate">
                 <span class="pre">
                  shard_full_optim_state_dict()
                 </span>
                </code>
               </a>
               and
               <a class="reference internal" href="#torch.distributed.fsdp.FullyShardedDataParallel.scatter_full_optim_state_dict" title="torch.distributed.fsdp.FullyShardedDataParallel.scatter_full_optim_state_dict">
                <code class="xref py py-meth docutils literal notranslate">
                 <span class="pre">
                  scatter_full_optim_state_dict()
                 </span>
                </code>
               </a>
               may be used to get the
sharded optimizer state dict to load. Assuming that the full
optimizer state dict resides in CPU memory, the former requires
each rank to have the full dict in CPU memory, where each rank
individually shards the dict without any communication, while the
latter requires only rank 0 to have the full dict in CPU memory,
where rank 0 moves each shard to GPU memory (for NCCL) and
communicates it to ranks appropriately. Hence, the former has
higher aggregate CPU memory cost, while the latter has higher
communication cost.
              </p>
             </div>
             <dl class="field-list simple">
              <dt class="field-odd">
               Parameters
              </dt>
              <dd class="field-odd">
               <ul class="simple">
                <li>
                 <p>
                  <strong>
                   full_optim_state_dict
                  </strong>
                  (
                  <em>
                   Dict
                  </em>
                  <em>
                   [
                  </em>
                  <a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.10)">
                   <em>
                    str
                   </em>
                  </a>
                  <em>
                   ,
                  </em>
                  <em>
                   Any
                  </em>
                  <em>
                   ]
                  </em>
                  ) – Optimizer state dict
corresponding to the unflattened parameters and holding the
full non-sharded optimizer state.
                 </p>
                </li>
                <li>
                 <p>
                  <strong>
                   model
                  </strong>
                  (
                  <a class="reference internal" href="generated/torch.nn.Module.html#torch.nn.Module" title="torch.nn.Module">
                   <em>
                    torch.nn.Module
                   </em>
                  </a>
                  ) – Root module (which may or may not be a
                  <a class="reference internal" href="#torch.distributed.fsdp.FullyShardedDataParallel" title="torch.distributed.fsdp.FullyShardedDataParallel">
                   <code class="xref py py-class docutils literal notranslate">
                    <span class="pre">
                     FullyShardedDataParallel
                    </span>
                   </code>
                  </a>
                  instance) whose parameters
correspond to the optimizer state in
                  <code class="docutils literal notranslate">
                   <span class="pre">
                    full_optim_state_dict
                   </span>
                  </code>
                  .
                 </p>
                </li>
                <li>
                 <p>
                  <strong>
                   optim_input
                  </strong>
                  (
                  <em>
                   Optional
                  </em>
                  <em>
                   [
                  </em>
                  <em>
                   Union
                  </em>
                  <em>
                   [
                  </em>
                  <em>
                   List
                  </em>
                  <em>
                   [
                  </em>
                  <em>
                   Dict
                  </em>
                  <em>
                   [
                  </em>
                  <a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.10)">
                   <em>
                    str
                   </em>
                  </a>
                  <em>
                   ,
                  </em>
                  <em>
                   Any
                  </em>
                  <em>
                   ]
                  </em>
                  <em>
                   ]
                  </em>
                  <em>
                   ,
                  </em>
                  <em>
                   Iterable
                  </em>
                  <em>
                   [
                  </em>
                  <em>
                   torch.nn.Parameter
                  </em>
                  <em>
                   ]
                  </em>
                  <em>
                   ]
                  </em>
                  <em>
                   ]
                  </em>
                  ) – Input passed into the optimizer representing either a
                  <a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#list" title="(in Python v3.10)">
                   <code class="xref py py-class docutils literal notranslate">
                    <span class="pre">
                     list
                    </span>
                   </code>
                  </a>
                  of parameter groups or an iterable of parameters;
if
                  <code class="docutils literal notranslate">
                   <span class="pre">
                    None
                   </span>
                  </code>
                  , then this method assumes the input was
                  <code class="docutils literal notranslate">
                   <span class="pre">
                    model.parameters()
                   </span>
                  </code>
                  . (Default:
                  <code class="docutils literal notranslate">
                   <span class="pre">
                    None
                   </span>
                  </code>
                  )
                 </p>
                </li>
               </ul>
              </dd>
              <dt class="field-even">
               Returns
              </dt>
              <dd class="field-even">
               <p>
                The full optimizer state dict now remapped to
flattened parameters instead of unflattened parameters and
restricted to only include this rank’s part of the optimizer state.
               </p>
              </dd>
              <dt class="field-odd">
               Return type
              </dt>
              <dd class="field-odd">
               <p>
                Dict[
                <a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.10)">
                 str
                </a>
                , Any]
               </p>
              </dd>
             </dl>
            </dd>
           </dl>
           <dl class="py method">
            <dt id="torch.distributed.fsdp.FullyShardedDataParallel.state_dict">
             <code class="sig-name descname">
              <span class="pre">
               state_dict
              </span>
             </code>
             <span class="sig-paren">
              (
             </span>
             <em class="sig-param">
              <span class="o">
               <span class="pre">
                *
               </span>
              </span>
              <span class="n">
               <span class="pre">
                args
               </span>
              </span>
             </em>
             ,
             <em class="sig-param">
              <span class="o">
               <span class="pre">
                **
               </span>
              </span>
              <span class="n">
               <span class="pre">
                kwargs
               </span>
              </span>
             </em>
             <span class="sig-paren">
              )
             </span>
             <a class="reference internal" href="_modules/torch/distributed/fsdp/fully_sharded_data_parallel.html#FullyShardedDataParallel.state_dict">
              <span class="viewcode-link">
               <span class="pre">
                [source]
               </span>
              </span>
             </a>
             <a class="headerlink" href="#torch.distributed.fsdp.FullyShardedDataParallel.state_dict" title="Permalink to this definition">
              ¶
             </a>
            </dt>
            <dd>
             <p>
              This is the entry point of all three FSDP
              <code class="docutils literal notranslate">
               <span class="pre">
                state_dict
               </span>
              </code>
              APIs: full,
local, and sharded. For the full state dict
(
              <code class="docutils literal notranslate">
               <span class="pre">
                StateDictType.FULL_STATE_DICT
               </span>
              </code>
              ), FSDP attempts to unshard the model
on all ranks, which may result in an OOM error if the full model cannot
fit on a single GPU. In that case, users may pass in a
              <code class="xref py py-class docutils literal notranslate">
               <span class="pre">
                FullStateDictConfig
               </span>
              </code>
              to only save the checkpoint on rank 0 and/
or to offload it to CPU memory layer by layer, enabling much larger
checkpoints. If the full model cannot fit in CPU memory, then users may
instead take a local state dict (
              <code class="docutils literal notranslate">
               <span class="pre">
                StateDictType.LOCAL_STATE_DICT
               </span>
              </code>
              )
that only saves the local shard of the model. The sharded state dict
(
              <code class="docutils literal notranslate">
               <span class="pre">
                StateDictType.SHARDED_STATE_DICT
               </span>
              </code>
              ) saves the model parameters as
              <code class="docutils literal notranslate">
               <span class="pre">
                ShardedTensor
               </span>
              </code>
              s. The
              <code class="docutils literal notranslate">
               <span class="pre">
                state_dict
               </span>
              </code>
              type can be configured using
the
              <a class="reference internal" href="#torch.distributed.fsdp.FullyShardedDataParallel.state_dict_type" title="torch.distributed.fsdp.FullyShardedDataParallel.state_dict_type">
               <code class="xref py py-meth docutils literal notranslate">
                <span class="pre">
                 state_dict_type()
                </span>
               </code>
              </a>
              context manager.
             </p>
             <p>
              Example:
             </p>
             <div class="highlight-default notranslate">
              <div class="highlight">
               <pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">torch</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">torch.distributed.fsdp</span> <span class="kn">import</span> <span class="n">FullyShardedDataParallel</span> <span class="k">as</span> <span class="n">FSDP</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">torch.distributed.fsdp</span> <span class="kn">import</span> <span class="n">StateDictType</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">set_device</span><span class="p">(</span><span class="n">device_id</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">my_module</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">sharded_module</span> <span class="o">=</span> <span class="n">FSDP</span><span class="p">(</span><span class="n">my_module</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">full_state_dict_config</span> <span class="o">=</span> <span class="n">FullStateDictConfig</span><span class="p">(</span><span class="n">offload_to_cpu</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">rank0_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">with</span> <span class="n">FSDP</span><span class="o">.</span><span class="n">state_dict_type</span><span class="p">(</span><span class="n">sharded_module</span><span class="p">,</span> <span class="n">StateDictType</span><span class="o">.</span><span class="n">FULL_STATE_DICT</span><span class="p">,</span> <span class="n">full_state_dict_config</span><span class="p">):</span>
<span class="gp">&gt;&gt;&gt; </span>    <span class="n">full_dict</span> <span class="o">=</span> <span class="n">sharded_module</span><span class="o">.</span><span class="n">state_dict</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">full_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">odict_keys</span><span class="p">([</span><span class="s1">'weight'</span><span class="p">,</span> <span class="s1">'bias'</span><span class="p">])</span>
<span class="gp">&gt;&gt;&gt; </span><span class="c1"># using local state dict</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">with</span> <span class="n">FSDP</span><span class="o">.</span><span class="n">state_dict_type</span><span class="p">(</span><span class="n">sharded_module</span><span class="p">,</span> <span class="n">StateDictType</span><span class="o">.</span><span class="n">LOCAL_STATE_DICT</span><span class="p">):</span>
<span class="gp">&gt;&gt;&gt; </span>    <span class="n">local_dict</span> <span class="o">=</span> <span class="n">sharded_module</span><span class="o">.</span><span class="n">state_dict</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">local_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">odict_keys</span><span class="p">([</span><span class="s1">'flat_param'</span><span class="p">,</span> <span class="s1">'inner.flat_param'</span><span class="p">])</span>
</pre>
              </div>
             </div>
             <div class="admonition warning">
              <p class="admonition-title">
               Warning
              </p>
              <p>
               This needs to be called on all ranks, since synchronization
primitives may be used.
              </p>
             </div>
            </dd>
           </dl>
           <dl class="py method">
            <dt id="torch.distributed.fsdp.FullyShardedDataParallel.state_dict_type">
             <em class="property">
              <span class="pre">
               static
              </span>
             </em>
             <code class="sig-name descname">
              <span class="pre">
               state_dict_type
              </span>
             </code>
             <span class="sig-paren">
              (
             </span>
             <em class="sig-param">
              <span class="n">
               <span class="pre">
                module
               </span>
              </span>
             </em>
             ,
             <em class="sig-param">
              <span class="n">
               <span class="pre">
                state_dict_type
               </span>
              </span>
             </em>
             ,
             <em class="sig-param">
              <span class="n">
               <span class="pre">
                state_dict_config
               </span>
              </span>
              <span class="o">
               <span class="pre">
                =
               </span>
              </span>
              <span class="default_value">
               <span class="pre">
                None
               </span>
              </span>
             </em>
             <span class="sig-paren">
              )
             </span>
             <a class="reference internal" href="_modules/torch/distributed/fsdp/fully_sharded_data_parallel.html#FullyShardedDataParallel.state_dict_type">
              <span class="viewcode-link">
               <span class="pre">
                [source]
               </span>
              </span>
             </a>
             <a class="headerlink" href="#torch.distributed.fsdp.FullyShardedDataParallel.state_dict_type" title="Permalink to this definition">
              ¶
             </a>
            </dt>
            <dd>
             <p>
              A context manager to set the
              <code class="docutils literal notranslate">
               <span class="pre">
                state_dict_type
               </span>
              </code>
              of all the descendant
FSDP modules of the target module. The target module does not have to
be a FSDP module. If the target module is a FSDP module, its
              <code class="docutils literal notranslate">
               <span class="pre">
                state_dict_type
               </span>
              </code>
              will also be changed.
             </p>
             <div class="admonition note">
              <p class="admonition-title">
               Note
              </p>
              <p>
               This API should be called for only the top-level (root)
module.
              </p>
             </div>
             <div class="admonition note">
              <p class="admonition-title">
               Note
              </p>
              <p>
               This API enables users to transparently use the conventional
               <code class="docutils literal notranslate">
                <span class="pre">
                 state_dict
                </span>
               </code>
               API to take model checkpoints in cases where the
root FSDP module is wrapped by another
               <code class="docutils literal notranslate">
                <span class="pre">
                 nn.Module
                </span>
               </code>
               . For example,
the following will ensure
               <code class="docutils literal notranslate">
                <span class="pre">
                 state_dict
                </span>
               </code>
               is called on all non-FSDP
instances, while dispatching into
               <cite>
                local_state_dict
               </cite>
               implementation
for FSDP:
              </p>
             </div>
             <p>
              Example:
             </p>
             <div class="highlight-default notranslate">
              <div class="highlight">
               <pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">model</span> <span class="o">=</span> <span class="n">DDP</span><span class="p">(</span><span class="n">FSDP</span><span class="p">(</span><span class="o">...</span><span class="p">))</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">with</span> <span class="n">FSDP</span><span class="o">.</span><span class="n">state_dict_type</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">StateDictType</span><span class="o">.</span><span class="n">LOCAL_STATE_DICT</span><span class="p">):</span>
<span class="gp">&gt;&gt;&gt; </span>    <span class="n">checkpoint</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">state_dict</span><span class="p">()</span>
</pre>
              </div>
             </div>
             <dl class="field-list simple">
              <dt class="field-odd">
               Parameters
              </dt>
              <dd class="field-odd">
               <ul class="simple">
                <li>
                 <p>
                  <strong>
                   module
                  </strong>
                  (
                  <a class="reference internal" href="generated/torch.nn.Module.html#torch.nn.Module" title="torch.nn.Module">
                   <em>
                    torch.nn.Module
                   </em>
                  </a>
                  ) – Root module.
                 </p>
                </li>
                <li>
                 <p>
                  <strong>
                   state_dict_type
                  </strong>
                  (
                  <em>
                   StateDictType
                  </em>
                  ) – the desired
                  <code class="docutils literal notranslate">
                   <span class="pre">
                    state_dict_type
                   </span>
                  </code>
                  to set.
                 </p>
                </li>
               </ul>
              </dd>
             </dl>
            </dd>
           </dl>
           <dl class="py method">
            <dt id="torch.distributed.fsdp.FullyShardedDataParallel.summon_full_params">
             <em class="property">
              <span class="pre">
               static
              </span>
             </em>
             <code class="sig-name descname">
              <span class="pre">
               summon_full_params
              </span>
             </code>
             <span class="sig-paren">
              (
             </span>
             <em class="sig-param">
              <span class="n">
               <span class="pre">
                module
               </span>
              </span>
             </em>
             ,
             <em class="sig-param">
              <span class="n">
               <span class="pre">
                recurse
               </span>
              </span>
              <span class="o">
               <span class="pre">
                =
               </span>
              </span>
              <span class="default_value">
               <span class="pre">
                True
               </span>
              </span>
             </em>
             ,
             <em class="sig-param">
              <span class="n">
               <span class="pre">
                writeback
               </span>
              </span>
              <span class="o">
               <span class="pre">
                =
               </span>
              </span>
              <span class="default_value">
               <span class="pre">
                True
               </span>
              </span>
             </em>
             ,
             <em class="sig-param">
              <span class="n">
               <span class="pre">
                rank0_only
               </span>
              </span>
              <span class="o">
               <span class="pre">
                =
               </span>
              </span>
              <span class="default_value">
               <span class="pre">
                False
               </span>
              </span>
             </em>
             ,
             <em class="sig-param">
              <span class="n">
               <span class="pre">
                offload_to_cpu
               </span>
              </span>
              <span class="o">
               <span class="pre">
                =
               </span>
              </span>
              <span class="default_value">
               <span class="pre">
                False
               </span>
              </span>
             </em>
             <span class="sig-paren">
              )
             </span>
             <a class="reference internal" href="_modules/torch/distributed/fsdp/fully_sharded_data_parallel.html#FullyShardedDataParallel.summon_full_params">
              <span class="viewcode-link">
               <span class="pre">
                [source]
               </span>
              </span>
             </a>
             <a class="headerlink" href="#torch.distributed.fsdp.FullyShardedDataParallel.summon_full_params" title="Permalink to this definition">
              ¶
             </a>
            </dt>
            <dd>
             <p>
              A context manager to expose full params for FSDP instances.
Can be useful
              <em>
               after
              </em>
              forward/backward for a model to get
the params for additional processing or checking. It can take a non-FSDP
module and will summon full params for all contained FSDP modules as
well as their children, depending on the
              <code class="docutils literal notranslate">
               <span class="pre">
                recurse
               </span>
              </code>
              argument.
             </p>
             <div class="admonition note">
              <p class="admonition-title">
               Note
              </p>
              <p>
               This can be used on inner FSDPs.
              </p>
             </div>
             <div class="admonition note">
              <p class="admonition-title">
               Note
              </p>
              <p>
               This can
               <em>
                not
               </em>
               be used within a forward or backward pass. Nor
can forward and backward be started from within this context.
              </p>
             </div>
             <div class="admonition note">
              <p class="admonition-title">
               Note
              </p>
              <p>
               Parameters will revert to their local shards after the context
manager exits, storage behavior is the same as forward.
              </p>
             </div>
             <div class="admonition note">
              <p class="admonition-title">
               Note
              </p>
              <p>
               The full parameters can be modified, but only the portion
corresponding to the local param shard will persist after the
context manager exits (unless
               <code class="docutils literal notranslate">
                <span class="pre">
                 writeback=False
                </span>
               </code>
               , in which case
changes will be discarded). In the case where FSDP does not shard
the parameters, currently only when
               <code class="docutils literal notranslate">
                <span class="pre">
                 world_size
                </span>
                <span class="pre">
                 ==
                </span>
                <span class="pre">
                 1
                </span>
               </code>
               , or
               <code class="docutils literal notranslate">
                <span class="pre">
                 NO_SHARD
                </span>
               </code>
               config, the modification is persisted regardless of
               <code class="docutils literal notranslate">
                <span class="pre">
                 writeback
                </span>
               </code>
               .
              </p>
             </div>
             <div class="admonition note">
              <p class="admonition-title">
               Note
              </p>
              <p>
               This method works on modules which are not FSDP themselves but
may contain multiple independent FSDP units. In that case, the given
arguments will apply to all contained FSDP units.
              </p>
             </div>
             <div class="admonition warning">
              <p class="admonition-title">
               Warning
              </p>
              <p>
               Note that
               <code class="docutils literal notranslate">
                <span class="pre">
                 rank0_only=True
                </span>
               </code>
               in conjunction with
               <code class="docutils literal notranslate">
                <span class="pre">
                 writeback=True
                </span>
               </code>
               is not currently supported and will raise an
error. This is because model parameter shapes would be different
across ranks within the context, and writing to them can lead to
inconsistency across ranks when the context is exited.
              </p>
             </div>
             <div class="admonition warning">
              <p class="admonition-title">
               Warning
              </p>
              <p>
               Note that
               <code class="docutils literal notranslate">
                <span class="pre">
                 offload_to_cpu
                </span>
               </code>
               and
               <code class="docutils literal notranslate">
                <span class="pre">
                 rank0_only=False
                </span>
               </code>
               will
result in full parameters being redundantly copied to CPU memory for
GPUs that reside on the same machine, which may incur the risk of
CPU OOM. It is recommended to use
               <code class="docutils literal notranslate">
                <span class="pre">
                 offload_to_cpu
                </span>
               </code>
               with
               <code class="docutils literal notranslate">
                <span class="pre">
                 rank0_only=True
                </span>
               </code>
               .
              </p>
             </div>
             <dl class="field-list simple">
              <dt class="field-odd">
               Parameters
              </dt>
              <dd class="field-odd">
               <ul class="simple">
                <li>
                 <p>
                  <strong>
                   recurse
                  </strong>
                  (
                  <a class="reference external" href="https://docs.python.org/3/library/functions.html#bool" title="(in Python v3.10)">
                   <em>
                    bool
                   </em>
                  </a>
                  <em>
                   ,
                  </em>
                  <em>
                   Optional
                  </em>
                  ) – recursively summon all params for nested
FSDP instances (default: True).
                 </p>
                </li>
                <li>
                 <p>
                  <strong>
                   writeback
                  </strong>
                  (
                  <a class="reference external" href="https://docs.python.org/3/library/functions.html#bool" title="(in Python v3.10)">
                   <em>
                    bool
                   </em>
                  </a>
                  <em>
                   ,
                  </em>
                  <em>
                   Optional
                  </em>
                  ) – if
                  <code class="docutils literal notranslate">
                   <span class="pre">
                    False
                   </span>
                  </code>
                  , modifications to params are
discarded after the context manager exists;
disabling this can be slightly more efficient (default: True)
                 </p>
                </li>
                <li>
                 <p>
                  <strong>
                   rank0_only
                  </strong>
                  (
                  <a class="reference external" href="https://docs.python.org/3/library/functions.html#bool" title="(in Python v3.10)">
                   <em>
                    bool
                   </em>
                  </a>
                  <em>
                   ,
                  </em>
                  <em>
                   Optional
                  </em>
                  ) – if
                  <code class="docutils literal notranslate">
                   <span class="pre">
                    True
                   </span>
                  </code>
                  , full parameters are
materialized on only global rank 0. This means that within the
context, only rank 0 will have full parameters and the other
ranks will have sharded parameters. Note that setting
                  <code class="docutils literal notranslate">
                   <span class="pre">
                    rank0_only=True
                   </span>
                  </code>
                  with
                  <code class="docutils literal notranslate">
                   <span class="pre">
                    writeback=True
                   </span>
                  </code>
                  is not supported,
as model parameter shapes will be different across ranks
within the context, and writing to them can lead to
inconsistency across ranks when the context is exited.
                 </p>
                </li>
                <li>
                 <p>
                  <strong>
                   offload_to_cpu
                  </strong>
                  (
                  <a class="reference external" href="https://docs.python.org/3/library/functions.html#bool" title="(in Python v3.10)">
                   <em>
                    bool
                   </em>
                  </a>
                  <em>
                   ,
                  </em>
                  <em>
                   Optional
                  </em>
                  ) – If
                  <code class="docutils literal notranslate">
                   <span class="pre">
                    True
                   </span>
                  </code>
                  , full parameters are
offloaded to CPU. Note that this offloading currently only
occurs if the parameter is sharded (which is only not the case
for world_size = 1 or
                  <code class="docutils literal notranslate">
                   <span class="pre">
                    NO_SHARD
                   </span>
                  </code>
                  config). It is recommended
to use
                  <code class="docutils literal notranslate">
                   <span class="pre">
                    offload_to_cpu
                   </span>
                  </code>
                  with
                  <code class="docutils literal notranslate">
                   <span class="pre">
                    rank0_only=True
                   </span>
                  </code>
                  to avoid
redundant copies of model parameters being offloaded to the same CPU memory.
                 </p>
                </li>
               </ul>
              </dd>
             </dl>
            </dd>
           </dl>
          </dd>
         </dl>
        </div>
       </article>
      </div>
     </div>
    </div>
   </section>
  </div>
 </body>
</html>